generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  RADNIK
  MODERATOR
  ADMIN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
}

enum SettlementType {
  FINAL
  INTERIM
}

enum RepairStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model User {
  id             String           @id @default(cuid())
  username       String           @unique
  passwordHash   String
  firstName      String
  lastName       String
  role           Role
  employmentType EmploymentType
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  branches       UserBranch[]
  documents      UserDocument[]
  auditLogs      AuditLog[]
  messagesSent   ChatMessage[]    @relation("message_sender")
}

model Branch {
  id            String          @id @default(cuid())
  name          String
  code          String          @unique
  city          String
  address       String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  users         UserBranch[]
  settlements   Settlement[]
  repairs       Repair[]
  notes         BranchNote[]
  documents     BranchDocument[]
}

model UserBranch {
  id       String @id @default(cuid())
  userId   String
  branchId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
}

model Settlement {
  id             String         @id @default(cuid())
  branchId        String
  createdById     String
  period          String
  type            SettlementType
  cashierTotal    Decimal        @db.Decimal(12, 2)
  zastrapayTotal  Decimal        @db.Decimal(12, 2)
  terminalTotal   Decimal        @db.Decimal(12, 2)
  locked          Boolean        @default(false)
  finalizedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  branch          Branch         @relation(fields: [branchId], references: [id])
}

model Repair {
  id           String       @id @default(cuid())
  branchId      String
  reportedById  String
  description   String
  status        RepairStatus @default(OPEN)
  openedAt      DateTime     @default(now())
  resolvedAt    DateTime?
  branch        Branch       @relation(fields: [branchId], references: [id])
}

model ChatMessage {
  id           String   @id @default(cuid())
  senderId     String
  receiverId   String?
  room         String
  content      String
  createdAt    DateTime @default(now())
  sender       User     @relation("message_sender", fields: [senderId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String?
  action      String
  entityType  String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation(fields: [actorId], references: [id])
}

model AppSetting {
  id            String   @id @default(cuid())
  key           String   @unique
  value         String
  updatedAt     DateTime @updatedAt
}

model BranchNote {
  id          String   @id @default(cuid())
  branchId    String
  content     String
  createdAt   DateTime @default(now())
  branch      Branch   @relation(fields: [branchId], references: [id])
}

model UserDocument {
  id          String   @id @default(cuid())
  userId      String
  path        String
  mimeType    String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model BranchDocument {
  id          String   @id @default(cuid())
  branchId    String
  path        String
  mimeType    String
  createdAt   DateTime @default(now())
  branch      Branch   @relation(fields: [branchId], references: [id])
}
